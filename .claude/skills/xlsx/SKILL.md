---
name: xlsx
description: "Создание, редактирование и анализ электронных таблиц (.xlsx, .xlsm, .csv, .tsv). ИСПОЛЬЗУЙ ЭТОТ SKILL КОГДА: пользователь просит (1) Создать таблицу с формулами и профессиональным оформлением, (2) Прочитать/проанализировать данные из Excel, (3) Отредактировать существующий файл с сохранением формул, (4) Пересчитать формулы после изменений, (5) Применить визуальное оформление (цвета, границы, условное форматирование). Примеры запросов: 'создай отчет по продажам', 'добавь формулу в колонку', 'сделай красивую таблицу с зебра-эффектом', 'построй финансовую модель'. Автоматически использует openpyxl для формул/форматирования и pandas для анализа данных. ОБЯЗАТЕЛЬНО пересчитывает формулы через scripts/recalc.py для детекции ошибок (#DIV/0!, #REF!, #VALUE!, #NAME?, #N/A)."
allowed-tools: Read, Write, Edit, Bash(cmd:*), Bash(python:*), Bash(python3:*)
version: 2.0.0
author: Excel Automation Team
license: Proprietary. LICENSE.txt has complete terms
---

# Обзор

Этот скилл предоставляет комплексные возможности для работы с Excel файлами:
- Создание новых таблиц с формулами и форматированием
- Редактирование существующих файлов с сохранением формул
- Анализ данных из таблиц
- Применение профессионального визуального оформления
- Пересчет и валидация формул

## Обязательные требования

### Ноль ошибок в формулах
Каждый Excel файл ДОЛЖЕН быть доставлен с НУЛЕМ ошибок формул (#REF!, #DIV/0!, #VALUE!, #N/A, #NAME?).

### Сохранение существующих шаблонов
При модификации файлов:
- Изучить и ТОЧНО соответствовать существующему формату, стилю и соглашениям
- Никогда не навязывать стандартизированное форматирование файлам с установленными паттернами
- Существующие соглашения шаблонов ВСЕГДА переопределяют эти руководящие принципы

### LibreOffice для пересчета формул
LibreOffice установлен для пересчета формул с помощью `scripts/recalc.py`. Скрипт автоматически настраивается при первом запуске.

## Быстрый старт

### Создание нового файла

```python
from openpyxl import Workbook
from openpyxl.styles import Font, PatternFill

wb = Workbook()
sheet = wb.active

# Add data and formulas
sheet['A1'] = 'Название'
sheet['B1'] = 'Значение'
sheet['B2'] = '=SUM(B3:B10)'

# Apply formatting (см. [visual-styling.md](references/visual-styling.md) для деталей)
sheet['A1'].font = Font(bold=True)
sheet['A1'].fill = PatternFill('solid', start_color='D9E1F2')

wb.save('output.xlsx')
```

### Редактирование существующего файла

```python
from openpyxl import load_workbook

wb = load_workbook('existing.xlsx')
sheet = wb.active

# Modify data
sheet['A1'] = 'New Value'

# Add formula
sheet['C10'] = '=AVERAGE(C2:C9)'

wb.save('modified.xlsx')
```

### Анализ данных

```python
import pandas as pd

# Read and analyze
df = pd.read_excel('file.xlsx')
df.head()
df.describe()

# Export results
df.to_excel('output.xlsx', index=False)
```

## Основной рабочий процесс

1. **Выбрать инструмент**: pandas для анализа данных, openpyxl для формул/форматирования
2. **Создать/Загрузить**: Создать новую книгу или загрузить существующий файл
3. **Модифицировать**: Добавить/отредактировать данные, формулы и форматирование
4. **Сохранить**: Записать в файл
5. **Пересчитать формулы (ОБЯЗАТЕЛЬНО при использовании формул)**:
   ```bash
   python scripts/recalc.py output.xlsx
   ```
6. **Проверить ошибки**: Если `status` равен `errors_found`, исправить проблемные формулы и пересчитать снова

## КРИТИЧЕСКИ ВАЖНО: Использовать формулы, а не жестко закодированные значения

**Всегда используйте формулы Excel вместо вычисления значений в Python.**

❌ НЕПРАВИЛЬНО:
```python
total = df['Sales'].sum()
sheet['B10'] = total  # Hardcoded value
```

✅ ПРАВИЛЬНО:
```python
sheet['B10'] = '=SUM(B2:B9)'  # Excel formula
```

Это применимо ко ВСЕМ вычислениям - итогам, процентам, соотношениям, разницам и т.д.

## Визуальное оформление

Для применения профессионального оформления см. [visual-styling.md](references/visual-styling.md):

- **Общие таблицы** (отчеты, дашборды, списки):
  - Заголовки с светло-серым фоном
  - Зебра-эффект для читаемости
  - Цветовое выделение по смыслу (статусы, важные значения)
  - Условное форматирование (градиенты, иконки)

- **Финансовые модели**:
  - Строгие отраслевые стандарты цветового кодирования
  - Синий = входные данные, Черный = формулы, Зеленый = внутренние ссылки
  - Специальное форматирование чисел (валюта, проценты, кратности)

Быстрый поиск в references:
```bash
grep -A 10 "Общие таблицы" references/visual-styling.md
grep -A 20 "Финансовые модели" references/visual-styling.md
```

## Проверка и валидация формул

Для контрольного списка и стратегии тестирования см. [formulas-checklist.md](references/formulas-checklist.md):

- Основная проверка перед созданием формул
- Распространенные подводные камни (#DIV/0!, #REF!, #VALUE!)
- Стратегия тестирования
- Интерпретация вывода recalc.py
- Типичные исправления ошибок

Быстрый поиск:
```bash
grep -A 5 "#DIV/0!" references/formulas-checklist.md
grep -A 10 "Стратегия тестирования" references/formulas-checklist.md
```

## Подробные паттерны работы с библиотеками

Для детальных примеров кода см. [openpyxl-patterns.md](references/openpyxl-patterns.md):

- Выбор между pandas и openpyxl
- Создание и редактирование файлов
- Работа с форматированием (шрифты, цвета, границы)
- Работа с формулами (простые, абсолютные ссылки, межлистовые)
- Работа с большими файлами
- Лучшие практики openpyxl и pandas

Быстрый поиск:
```bash
grep -A 10 "pandas" references/openpyxl-patterns.md
grep -A 10 "форматированием" references/openpyxl-patterns.md
```

## Пересчет формул

Использовать скрипт `scripts/recalc.py` для пересчета всех формул:

```bash
python scripts/recalc.py <excel_file> [timeout_seconds]
```

Пример:
```bash
python scripts/recalc.py output.xlsx 30
```

Скрипт:
- Автоматически настраивает макрос LibreOffice при первом запуске
- Пересчитывает все формулы во всех листах
- Сканирует ВСЕ ячейки на ошибки Excel
- Возвращает JSON с подробными местоположениями ошибок и их количеством
- Работает на Linux и macOS

## Структура скилла

```
xlsx/
├── SKILL.md                      # Этот файл
├── LICENSE.txt                   # Лицензия
├── scripts/
│   └── recalc.py                # Пересчет формул
├── references/
│   ├── visual-styling.md        # Визуальное оформление
│   ├── formulas-checklist.md    # Проверка формул
│   └── openpyxl-patterns.md     # Паттерны работы с библиотеками
└── assets/
    └── (шаблоны для будущего использования)
```

## Когда использовать этот скилл

Используйте этот скилл когда пользователь просит:
- Создать Excel файл или таблицу
- Добавить формулы в таблицу
- Применить оформление (цвета, границы, стили)
- Прочитать/проанализировать данные из Excel
- Создать отчет, дашборд, или финансовую модель
- Экспортировать данные в Excel формат

## Руководящие принципы стиля кода

**Для Python кода**:
- Писать минимальный, краткий код без ненужных комментариев
- Избегать многословных имен переменных
- Избегать ненужных операторов print

**Для Excel файлов**:
- Добавлять комментарии к ячейкам со сложными формулами
- Документировать источники данных для жестко закодированных значений
- Включать примечания для ключевых вычислений
