# Контрольный список проверки формул

Быстрые проверки, чтобы убедиться, что формулы работают правильно перед сохранением и пересчетом.

## Обязательное требование

**Ноль ошибок в формулах** - Каждая модель Excel ДОЛЖНА быть доставлена с НУЛЕМ ошибок формул:
- `#REF!` - некорректные ссылки на ячейки
- `#DIV/0!` - деление на ноль
- `#VALUE!` - неправильный тип данных в формуле
- `#N/A` - значение недоступно
- `#NAME?` - неопознанное имя формулы

## Основная проверка

- [ ] **Тестировать 2-3 примерных ссылки**: Убедиться, что они извлекают правильные значения перед построением полной модели
- [ ] **Соответствие столбцов**: Подтвердить, что столбцы Excel соответствуют (например, столбец 64 = BL, а не BK)
- [ ] **Смещение строк**: Помнить, что строки Excel индексируются с 1 (строка DataFrame 5 = строка Excel 6)

## Распространенные подводные камни

- [ ] **Обработка NaN**: Проверить на нулевые значения с помощью `pd.notna()` перед использованием в формулах
- [ ] **Дальние правые столбцы**: Данные FY часто в столбцах 50+, убедиться что ссылки корректны
- [ ] **Множественные совпадения**: Искать все вхождения, а не только первое
- [ ] **Деление на ноль**: Проверить знаменатели перед использованием `/` в формулах (#DIV/0!)
- [ ] **Неправильные ссылки**: Убедиться, что все ссылки на ячейки указывают на нужные ячейки (#REF!)
- [ ] **Межлистовые ссылки**: Использовать правильный формат (Sheet1!A1) для связи листов

## Стратегия тестирования формул

- [ ] **Начать с малого**: Протестировать формулы на 2-3 ячейках перед широким применением
- [ ] **Проверить зависимости**: Убедиться, что все ячейки, на которые ссылаются формулы, существуют
- [ ] **Тестировать граничные случаи**: Включить нулевые, отрицательные и очень большие значения
- [ ] **Консистентность формул**: Убедиться что формулы одинаковы во всех периодах/столбцах (где применимо)

## Интерпретация вывода recalc.py

Скрипт `scripts/recalc.py` возвращает JSON с деталями ошибок:

```json
{
  "status": "success",           // or "errors_found"
  "total_errors": 0,              // Total error count
  "total_formulas": 42,           // Number of formulas in file
  "error_summary": {              // Only present if errors found
    "#REF!": {
      "count": 2,
      "locations": ["Sheet1!B5", "Sheet1!C10"]
    },
    "#DIV/0!": {
      "count": 1,
      "locations": ["Sheet1!D15"]
    }
  }
}
```

### Действия при обнаружении ошибок

1. **Проанализировать error_summary**: Определить типы ошибок и их местоположение
2. **Исправить ошибки**: Открыть файл и исправить проблемные формулы
3. **Пересчитать снова**: Запустить `scripts/recalc.py` повторно
4. **Повторять**: Пока `status` не станет `"success"` и `total_errors` не станет `0`

## Типичные исправления ошибок

### #REF! - Некорректные ссылки
```python
# Плохо - ссылка на несуществующую ячейку
sheet['B5'] = '=A100'  # если в таблице только 50 строк

# Хорошо - проверить диапазон перед созданием формулы
max_row = sheet.max_row
if max_row >= 100:
    sheet['B5'] = '=A100'
```

### #DIV/0! - Деление на ноль
```python
# Плохо - деление без проверки
sheet['C5'] = '=A5/B5'  # если B5 может быть 0

# Хорошо - использовать IFERROR или проверку
sheet['C5'] = '=IFERROR(A5/B5, 0)'
# или
sheet['C5'] = '=IF(B5<>0, A5/B5, 0)'
```

### #VALUE! - Неправильный тип данных
```python
# Плохо - текст в числовой формуле
sheet['D5'] = '=A5+B5'  # если A5 содержит текст

# Хорошо - конвертировать или проверить
sheet['D5'] = '=VALUE(A5)+B5'
# или использовать IFERROR
sheet['D5'] = '=IFERROR(A5+B5, 0)'
```

### #NAME? - Неопознанное имя
```python
# Плохо - опечатка в имени функции
sheet['E5'] = '=SUMM(A1:A10)'  # должно быть SUM

# Хорошо - правильное имя функции
sheet['E5'] = '=SUM(A1:A10)'
```

## Поиск информации

```bash
# Найти про конкретный тип ошибки
grep -A 5 "#REF!" references/formulas-checklist.md
grep -A 5 "#DIV/0!" references/formulas-checklist.md

# Найти стратегию тестирования
grep -A 10 "Стратегия тестирования" references/formulas-checklist.md
```
